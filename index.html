<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CherryDeals</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#1a001a; color:white; text-align:center; }
    h1 { font-size:50px; color:pink; margin-top:20px; }
    .menu { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin:20px 0; }
    .btn { padding:10px 20px; border:none; cursor:pointer; font-size:16px; border-radius:8px; background:white; color:black; }
    .btn.pink { background:pink; color:black; }
    .btn.green { background:green; color:white; }
    .btn.red { background:red; color:white; }
    .btn.gray { background:gray; color:white; }
    .form-box { margin:20px auto; padding:15px; max-width:400px; background:#2a002a; border-radius:10px; text-align:left; }
    input,select,textarea { width:100%; margin:5px 0 10px; padding:8px; border-radius:6px; border:none; }
    .deal-item { background:#330033; margin:10px auto; padding:10px; border-radius:6px; cursor:pointer; }
    .chat-box { max-width:500px; margin:0 auto; background:#2a002a; padding:10px; border-radius:8px; text-align:left; height:200px; overflow-y:auto; }
    .chat-input { display:flex; gap:5px; margin-top:10px; }
    .chat-input input { flex:1; }
  </style>
</head>
<body>
  <h1>CHERRY DEALS</h1>

  <div class="menu">
    <button class="btn pink" onclick="openSection('create')">–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
    <button class="btn" onclick="openSection('mydeals'); loadDeals()">–ú–æ–∏ —Å–¥–µ–ª–∫–∏</button>
    <button class="btn" onclick="openSection('chat'); loadChat()">–ß–∞—Ç</button>
    <button class="btn" onclick="openSection('balance'); loadBalance()">–ë–∞–ª–∞–Ω—Å</button>
    <button class="btn green" onclick="window.open('https://t.me/CherrysNews','_blank')">–ù–æ–≤–æ—Å—Ç–∏</button>
    <button class="btn red" onclick="window.open('https://t.me/CherrySuport','_blank')">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button>
  </div>

  <!-- –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É -->
  <div id="create" style="display:none;">
    <div class="form-box">
      <h3>–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</h3>
      <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label><textarea id="dealDesc"></textarea>
      <label>–°—É–º–º–∞:</label><input type="number" id="dealAmount">
      <label>–í–∞–ª—é—Ç–∞:</label>
      <select id="dealCurrency">
        <option>‚ÇΩ RUB</option><option>$ USD</option>
        <option>üíé TON</option><option>üíµ USDT</option><option>üåü STARS</option>
      </select>
      <label>–†–µ–∫–≤–∏–∑–∏—Ç—ã –ø—Ä–æ–¥–∞–≤—Ü–∞:</label><input type="text" id="dealReq">
      <button class="btn pink" onclick="createDeal()">‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É</button>
      <button class="btn gray" onclick="openSection('main')">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <!-- –ú–æ–∏ —Å–¥–µ–ª–∫–∏ -->
  <div id="mydeals" style="display:none;">
    <h3>–ú–æ–∏ —Å–¥–µ–ª–∫–∏</h3>
    <div id="dealsList"></div>
    <button class="btn gray" onclick="openSection('main')">‚¨Ö –ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–¥–µ–ª–∫–∏ -->
  <div id="dealView" style="display:none;">
    <div class="form-box" id="dealDetails"></div>
    <button class="btn gray" onclick="openSection('mydeals')">‚¨Ö –ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ß–∞—Ç -->
  <div id="chat" style="display:none;">
    <div class="chat-box" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É...">
      <button class="btn pink" onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
    <button class="btn gray" onclick="openSection('main')">‚¨Ö –ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ë–∞–ª–∞–Ω—Å -->
  <div id="balance" style="display:none;">
    <div class="form-box">
      <h3>–í–∞—à –±–∞–ª–∞–Ω—Å: <span id="userBalance">0</span> ‚ÇΩ</h3>
      <button class="btn pink" onclick="openSection('withdraw')">üí∏ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</button>
      <button class="btn pink" onclick="openSection('deposit')">‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
      <button class="btn gray" onclick="openSection('main')">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <!-- –í—ã–≤–æ–¥ -->
  <div id="withdraw" style="display:none;">
    <div class="form-box">
      <h3>–í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3>
      <label>–†–µ–∫–≤–∏–∑–∏—Ç—ã:</label><input id="withdrawReq">
      <label>–°—É–º–º–∞:</label><input type="number" id="withdrawAmount">
      <label>–í–∞–ª—é—Ç–∞:</label>
      <select id="withdrawCurrency">
        <option>‚ÇΩ RUB</option><option>$ USD</option><option>üíé TON</option><option>üíµ USDT</option>
      </select>
      <button class="btn pink" onclick="processWithdraw()">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="btn gray" onclick="openSection('balance')">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <!-- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
  <div id="deposit" style="display:none;">
    <div class="form-box">
      <h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
      <p>–†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</p>
      <p>üì± 89202555790</p>
      <p>üí≥ –ÆMoney</p>
      <p>–ï—Å–ª–∏ –Ω—É–∂–µ–Ω –∫—Ä–∏–ø—Ç–æ-–∞–¥—Ä–µ—Å ‚Üí –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ü–æ–¥–¥–µ—Ä–∂–∫—É.</p>
      <button class="btn gray" onclick="openSection('balance')">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
  </div>

<script>
  // üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase
  const supabaseUrl = "https://jlfmvzjxjibgxstmqlme.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsZm12emp4amliZ3hzdG1xbG1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0ODA5MzcsImV4cCI6MjA3NTA1NjkzN30.Qvv_vYHsEX-Ia5yGqiqInxdWnvrD-_cYh84fhJpMlcA";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser = "user_" + Math.floor(Math.random()*10000);
  let userRole = "user";

  function openSection(id){
    document.querySelectorAll("div[id]").forEach(div => div.style.display="none");
    if(id!=="main") document.getElementById(id).style.display="block";
  }

  // –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
  async function createDeal(){
    const desc = document.getElementById("dealDesc").value;
    const amount = document.getElementById("dealAmount").value;
    const currency = document.getElementById("dealCurrency").value;
    const req = document.getElementById("dealReq").value;
    if(!desc||!amount||!req) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
    const {data,error} = await supabaseClient.from("deals").insert([{seller:currentUser, description:desc, amount:amount, currency:currency, link:crypto.randomUUID(), status:"–ê–∫—Ç–∏–≤–Ω–∞"}]);
    if(error) alert(error.message); else {alert("–°–¥–µ–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!"); openSection("mydeals"); loadDeals();}
  }

  // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–¥–µ–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  async function loadDeals(){
    const {data,error} = await supabaseClient.from("deals").select("*").eq("seller",currentUser);
    if(error){console.log(error);return;}
    const list=document.getElementById("dealsList"); list.innerHTML="";
    data.forEach(d=>{
      const div=document.createElement("div");
      div.className="deal-item";
      div.innerText=`${d.description} ‚Ä¢ ${d.amount} ${d.currency}`;
      div.onclick=()=>viewDeal(d);
      list.appendChild(div);
    });
  }

  function viewDeal(d){
    openSection("dealView");
    document.getElementById("dealDetails").innerHTML=`
      <p><b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> ${d.description}</p>
      <p><b>–°—É–º–º–∞:</b> ${d.amount} ${d.currency}</p>
      <p><b>–°—Ç–∞—Ç—É—Å:</b> ${d.status}</p>
      <p><b>–°—Å—ã–ª–∫–∞:</b> ${location.origin}${location.pathname}?dealId=${d.link}</p>
      <button class="btn pink" onclick="payDeal('${d.id}')">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</button>
      <button class="btn pink" onclick="confirmDelivery('${d.id}')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–µ—Ä–µ–¥–∞—á—É</button>`;
  }

  async function payDeal(id){
    const username=prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram @username:");
    if(!username) return alert("–í–≤–µ–¥–∏—Ç–µ username!");
    const {data:deal}=await supabaseClient.from("deals").select("*").eq("id",id).single();
    alert("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–ø–ª–∞—Ç–∏–ª —Å–¥–µ–ª–∫—É! –ü–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Ç–æ–≤–∞—Ä —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ü–æ–¥–¥–µ—Ä–∂–∫—É!");
    await supabaseClient.from("deals").update({status:"–û–ø–ª–∞—á–µ–Ω–∞"}).eq("id",id);
    loadDeals();
  }

  async function confirmDelivery(id){
    await supabaseClient.from("deals").update({status:"–ó–∞–≤–µ—Ä—à–µ–Ω–∞"}).eq("id",id);
    alert("–¢–æ–≤–∞—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!");
    loadDeals();
  }

  // –ë–∞–ª–∞–Ω—Å
  async function loadBalance(){
    const {data,error}=await supabaseClient.from("balances").select("*").eq("user_id",currentUser).single();
    if(data) document.getElementById("userBalance").innerText=data.balance;
    else await supabaseClient.from("balances").insert([{user_id:currentUser,balance:0}]);
  }

  async function processWithdraw(){
    const sum=document.getElementById("withdrawAmount").value;
    const {data}=await supabaseClient.from("balances").select("*").eq("user_id",currentUser).single();
    if(data.balance<6000) return alert("–û—à–∏–±–∫–∞: –±–∞–ª–∞–Ω—Å –º–µ–Ω—å—à–µ 6000‚ÇΩ!");
    if(sum>data.balance) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
    await supabaseClient.from("balances").update({balance:data.balance-sum}).eq("user_id",currentUser);
    alert("–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
    loadBalance();
  }

  // –ß–∞—Ç
  async function sendChat(){
    const input=document.getElementById("chatInput"); const msg=input.value.trim(); if(!msg) return;
    input.value="";
    if(msg==="/cherryteam"){userRole="cherryteam"; await supabaseClient.from("messages").insert([{sender:"system",content:"–†–∞–¥—ã –≤–∏–¥–µ—Ç—å —Ç–µ–±—è –≤ —Ä—è–¥–∞—Ö TDT TEAM. –£–¥–∞—á–Ω—ã—Ö –ø—Ä–æ—Ñ–∏—Ç–æ–≤!",kind:"system"}]);}
    else if(msg==="/vladelec"){userRole="vladelec"; await supabaseClient.from("messages").insert([{sender:"system",content:"‚úÖ –í—ã –ø–æ–ª—É—á–∏–ª–∏ —Å—Ç–∞—Ç—É—Å –≤–ª–∞–¥–µ–ª—å—Ü–∞!",kind:"system"}]);}
    else if(msg==="/deals"){await supabaseClient.from("messages").insert([{sender:"system",content:"–í–∞—à–∏ —Å–¥–µ–ª–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ –ú–æ–∏ —Å–¥–µ–ª–∫–∏",kind:"system"}]);}
    else if(msg==="/dealsavladelec"&&userRole==="vladelec"){await supabaseClient.from("messages").insert([{sender:"system",content:"–í—Å–µ —Å–¥–µ–ª–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤–ª–∞–¥–µ–ª—å—Ü—É",kind:"system"}]);}
    else {await supabaseClient.from("messages").insert([{sender:currentUser,content:msg,kind:"chat"}]);}
    loadChat();
  }

  async function loadChat(){
    const {data}=await supabaseClient.from("messages").select("*").order("created_at",{ascending:true}).limit(50);
    const box=document.getElementById("chatMessages"); box.innerHTML=data.map(m=>`<p>${m.content}</p>`).join(""); box.scrollTop=box.scrollHeight;
  }

  // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–∏ —Å dealId
  window.onload=async()=>{
    const urlParams=new URLSearchParams(window.location.search);
    const dealId=urlParams.get("dealId");
    if(dealId){
      const {data}=await supabaseClient.from("deals").select("*").eq("link",dealId).single();
      if(data) viewDeal(data);
    }
  }
</script>
</body>
</html>
